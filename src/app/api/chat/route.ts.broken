import { openai } from '@ai-sdk/openai';
import { streamText, tool } from 'ai';
import { z } from 'zod';
import { createClient } from '@supabase/supabase-js';

// Cliente Supabase
const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
);

// Tiempo mÃ¡ximo de espera
export const maxDuration = 30;

export async function POST(req: Request) {
  // Obtenemos el mensaje del usuario
  const { messages, productInfo } = await req.json();

  // Contexto del producto si el usuario estÃ¡ viendo uno
  const productContext = productInfo 
    ? `\nCONTEXTO ACTUAL: El usuario estÃ¡ viendo el producto: ${productInfo.name} ($${productInfo.price}).` 
    : '';

  const systemPrompt = `
    Eres "Artesellos Bot", el asesor experto con mÃ¡s de 10 aÃ±os de experiencia fabricando timbres en Artesellos.
    No eres solo un buscador, eres un CONSULTOR que guÃ­a al cliente hacia la mejor opciÃ³n tÃ©cnica.

    ðŸ§  LÃ“GICA EXPERTA DE ASESORAMIENTO (ESTO ES LO QUE SABES):
    
    1. ðŸ‘©â€âš–ï¸ PARA ABOGADOS, MÃ‰DICOS Y PROFESIONALES DE LA SALUD:
       - El problema: Se mueven entre tribunales, consultas y hospitales. Necesitan algo que no manche el delantal o el traje.
       - TU RECOMENDACIÃ“N DE ORO: **Shiny 722 (Pocket/Bolsillo)** o **Trodat Mobile**.
       - Argumento de venta: "Como te mueves mucho, te recomiendo el modelo de bolsillo (Shiny 722). Es compacto, tiene clip para el delantal y el sistema de tinta queda sellado para no mancharte."
       - Medida estÃ¡ndar: 14x38mm (Perfecto para Nombre + Rut + Registro).

    2. ðŸ« PARA PROFESORES Y DOCENTES:
       - El problema: Corrigen cientos de pruebas. Necesitan durabilidad y rapidez.
       - TU RECOMENDACIÃ“N: **AutomÃ¡ticos de escritorio (Shiny 842 / Automatik 413)**.
       - Argumento: "Para corregir rÃ¡pido, lo mejor es un automÃ¡tico de escritorio robusto. Aguanta el uso intensivo."
       - DiseÃ±os comunes: "Revisado", caritas felices, "Falta completar".

    3. ðŸ¢ PARA EMPRESAS (FACTURACIÃ“N / RUT):
       - El problema: Necesitan poner RazÃ³n Social, Rut, DirecciÃ³n y Giro (mucha info).
       - TU RECOMENDACIÃ“N: Modelos medianos/grandes como **Shiny 844 (22x58mm)** o **Trodat 4913**.
       - Regla tÃ©cnica: "Para un timbre de empresa con direcciÃ³n completa, no uses el tamaÃ±o estÃ¡ndar (842), te quedarÃ¡ la letra ilegible. Sube al siguiente tamaÃ±o (844) para que se lea bien."

    4. ðŸ–Šï¸ FIRMAS Y MEDIA FIRMAS:
       - RecomendaciÃ³n: **Shiny 842** (14x38mm) es el estÃ¡ndar mundial para media firma.

    ðŸ› ï¸ DATOS TÃ‰CNICOS CRÃTICOS (NANO 2 / LÃSER):
    - Archivos: "Para logos, lo ideal es que me envÃ­es el archivo vectorial (Corel Draw, Illustrator) convertido a curvas. Si es imagen (JPG/PNG), debe ser en BLANCO Y NEGRO PURO (sin grises ni sombras), alta calidad."
    - TamaÃ±o de letra: "No recomiendo letras menores a 6pt, ya que la tinta y el polÃ­mero pueden empastarse y no se leerÃ¡ bien."

    TUS REGLAS DE COMPORTAMIENTO:
    1. Si el usuario dice su profesiÃ³n ("soy abogado"), **automÃ¡ticamente** sugiere el modelo ideal (Shiny 722) y explica por quÃ© antes de buscar stock.
    2. SIEMPRE usa la herramienta 'consultarStock' para verificar si tienes ese modelo recomendado disponible.
    3. SÃ© amable pero tÃ©cnico cuando sea necesario. Muestra autoridad en el tema.

    INFORMACIÃ“N COMERCIAL:
    - EnvÃ­os a todo Chile.
    - Medidas siempre en milÃ­metros (Ancho x Alto).
    
    ${productContext}
  `;

  try {
    const result = await streamText({
      model: openai('gpt-4o-mini'),
      messages,
      system: systemPrompt,
      tools: {
        consultarStock: tool({
          description: 'Busca timbres en el inventario por marca, modelo, color o cÃ³digo. Ãšsalo SIEMPRE que recomiendes un modelo.',
          parameters: z.object({
            termino: z.string().describe('El tÃ©rmino de bÃºsqueda, ej: "Shiny 722", "AutomÃ¡tico", "Rojo"'),
          }),
          execute: async ({ termino }) => {
            console.log(`ðŸ” Consultando DB para: ${termino}`);
            
            const { data, error } = await supabase
              .from('stock_timbres')
              .select('*')
              .or(`marca.ilike.%${termino}%,modelo.ilike.%${termino}%,color.ilike.%${termino}%,categoria.ilike.%${termino}%`)
              .order('stock', { ascending: false })
              .limit(5);

            if (error) {
              console.error("Error Supabase:", error);
              return "Error tÃ©cnico al consultar el inventario.";
            }
            
            if (!data || data.length === 0) {
              return "No encontrÃ© ese modelo exacto en stock, pero puedo ofrecerte alternativas similares.";
            }
            
            return JSON.stringify(data.map(item => ({
              producto: `${item.marca} ${item.modelo}`,
              color: item.color,
              stock: item.stock,
              medidas: `${item.ancho_mm}x${item.alto_mm}mm`,
              imagen: item.imagen_url
            })));
          },
        }),
      },
    });

    return result.toTextStreamResponse();

  } catch (error) {
    console.error("Error en route.ts:", error);
    return new Response(JSON.stringify({ error: "Error conectando con IA" }), { status: 500 });
  }
}