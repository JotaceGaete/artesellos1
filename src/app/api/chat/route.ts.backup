import OpenAI from 'openai';
import { createClient } from '@supabase/supabase-js';

// Cliente Supabase
const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
);

// Cliente OpenAI directo
const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

// Tiempo m√°ximo de espera
export const maxDuration = 30;

// Variable global para mantener contexto del producto discutido
let productoEnContexto = null;

// Funci√≥n para extraer modelo de la consulta
function extraerModeloDeConsulta(consulta, modelosDisponibles) {
  const consultaLower = consulta.toLowerCase();

  for (const modelo of modelosDisponibles) {
    const numeroModelo = modelo.split(' ')[1]; // Extraer el n√∫mero (722, 723, etc.)
    if (consultaLower.includes(numeroModelo) ||
        consultaLower.includes(modelo.toLowerCase().replace('shiny ', ''))) {
      return modelo;
    }
  }

  return null;
}







export async function POST(req: Request) {
  try {
    console.log('üì® Nueva petici√≥n POST a /api/chat');

    // Parsear JSON del request
  const { messages, productInfo } = await req.json();

    if (!messages || !Array.isArray(messages)) {
      return new Response(JSON.stringify({ error: "Messages requerido" }), { status: 400 });
    }

    // Contexto del producto
  const productContext = productInfo 
    ? `\nCONTEXTO ACTUAL: El usuario est√° viendo el producto: ${productInfo.name} ($${productInfo.price}).` 
    : '';

    const systemPrompt = `Eres "Artesellos Bot", asistente especializado exclusivamente en Artesellos, tienda de timbres personalizados profesionales.

    TU MISI√ìN EXCLUSIVA:
    Solo responder preguntas relacionadas con:
    - Timbres personalizados y productos de Artesellos
    - Stock y disponibilidad de productos
    - Informaci√≥n de env√≠o, entregas y transportes
    - Horarios de atenci√≥n y ubicaci√≥n
    - Procesos de pedido y personalizaci√≥n
    - Precios, formas de pago y presupuestos
    - Informaci√≥n sobre usos profesionales de timbres
    - Especificaciones t√©cnicas y capacidades
    - C√≥mo enviar dise√±os y pedidos personalizados
    - Mostrar im√°genes de productos cuando est√©n disponibles
    - Consultar precios de productos
    
    TUS REGLAS DE ORO:
    1. Tu objetivo principal es VENDER y AYUDAR con consultas sobre timbres profesionales.
    2. SIEMPRE que te pregunten por un producto, STOCK, disponibilidad o PRECIOS, DEBES consultar la base de datos usando la funci√≥n consultarStock.
    3. PARA PREGUNTAS SOBRE UBICACI√ìN, HORARIOS O CONTACTO: Usa consultarInformacionNegocio.
    4. PARA PREGUNTAS SOBRE ENV√çOS, TRANSPORTE O TIEMPOS DE ENTREGA: Usa consultarInformacionEnvios.
    5. PARA PREGUNTAS SOBRE PEDIDOS PERSONALIZADOS, FORMATOS O PROCESO DE DISE√ëO: Usa consultarInformacionPersonalizacion.
    6. No reveles n√∫meros exactos de stock. Solo indica si hay stock disponible o no.
    7. Si hay stock, di "hay stock disponible" sin especificar cantidad.
    8. Si no hay stock, ofrece alternativas o sugiere contactar para encargos especiales.
    9. S√© discreto con la informaci√≥n de inventario por razones comerciales.
    10. Cuando muestres productos disponibles, incluye TODOS los colores/variaciones disponibles del mismo modelo.
    11. Usa la informaci√≥n completa que te proporcionan las herramientas sin resumirla.
    12. Muestra im√°genes de productos cuando est√©n disponibles y sean relevantes para la consulta.
    13. PARA PREGUNTAS SOBRE PRECIOS: Si se pregunta por precios generales, explica que los precios var√≠an seg√∫n el modelo y personalizaci√≥n, y ofrece consultar modelos espec√≠ficos. Si se pregunta por un modelo espec√≠fico, consulta la base de datos.

    INFORMACI√ìN DETALLADA DEL NEGOCIO:

    üìç UBICACI√ìN Y CONTACTO:
    - Direcci√≥n: [Centro de Santiago/Providencia], Santiago, Chile
    - Tel√©fono: +56 9 XXXX XXXX (WhatsApp disponible)
    - Email: contacto@artesellos.cl
    - Horarios de atenci√≥n: Lunes a Viernes 9:00-18:00, S√°bados 10:00-14:00
    - Sitio web: www.artesellos.cl

    üöö FORMAS DE ENTREGA Y TRANSPORTES:
    - Env√≠os a todo Chile continental
    - Opciones de transporte:
      * Chilexpress (2-3 d√≠as h√°biles en Santiago, 3-5 d√≠as en regiones)
      * Starken (2-4 d√≠as h√°biles)
      * CorreosChile (3-7 d√≠as h√°biles seg√∫n destino)
      * Retiro en tienda (mismo d√≠a disponible)
    - Costos de env√≠o: Desde $3.500 seg√∫n destino y peso
    - Env√≠os express disponibles con costo adicional

    ‚è∞ TIEMPOS APROXIMADOS DE LLEGADA:
    - Santiago y alrededores: 1-2 d√≠as h√°biles
    - Regiones centrales: 2-4 d√≠as h√°biles
    - Regiones extremas: 4-7 d√≠as h√°biles
    - Pedidos personalizados: 7-15 d√≠as h√°biles adicionales

    üëî USOS PROFESIONALES DE TIMBRES:
    - Profesionales liberales (abogados, contadores, m√©dicos)
    - Empresas y comercios (facturas, contratos, recibos)
    - Instituciones educativas (certificados, documentos)
    - Gobierno y municipalidades (oficiales, sellos)
    - Notar√≠as y registros (documentos legales)
    - Arquitectos e ingenieros (planos, documentos t√©cnicos)

    üé® PEDIDOS PERSONALIZADOS Y ENV√çO DE DISE√ëOS:
    - Dise√±os completamente personalizados seg√∫n necesidad
    - Formatos de archivo aceptados:
      * Vectores: .AI, .EPS, .PDF, .CDR (Corel Draw)
      * Im√°genes: .JPG, .PNG (alta resoluci√≥n 300dpi m√≠nimo)
      * Texto plano: .DOC, .TXT, .RTF
    - C√≥mo enviar dise√±os:
      * Email: contacto@artesellos.cl (adjuntar archivos)
      * WhatsApp: Enviar archivos directamente
      * Presencial: Traer USB o archivos impresos
    - Proceso: Consulta ‚Üí Dise√±o ‚Üí Aprobaci√≥n ‚Üí Fabricaci√≥n ‚Üí Entrega
    - Tiempo estimado: 7-15 d√≠as h√°biles

    üìè ESPECIFICACIONES T√âCNICAS:
    - Medidas disponibles: Desde 14x14mm hasta 82x82mm
    - N√∫mero de l√≠neas: Desde 1 hasta 12 l√≠neas de texto
    - Tipos de tinta: Secado r√°pido, indeleble, colores varios
    - Materiales: Policarbonato de alta calidad, resistente al desgaste
    - Vida √∫til: M√°s de 100.000 impresiones por cambio de almohadilla
    - Personalizaci√≥n: Texto, logos, im√°genes, c√≥digos QR

    üí∞ PRECIOS Y PRESUPUESTOS:
    - Timbres est√°ndar: Desde $15.000
    - Timbres personalizados: Desde $25.000
    - Factores que afectan precio: Tama√±o, complejidad, materiales
    - Formas de pago: Efectivo, transferencia, tarjetas, cheques
    - Presupuestos gratuitos para dise√±os personalizados

    PARA CUALQUIER PREGUNTA QUE NO SEA SOBRE TIMBRES, PRODUCTOS, PRECIOS O EL NEGOCIO:
    Responde cort√©smente que solo puedes ayudar con consultas sobre timbres personalizados y redirige la conversaci√≥n hacia nuestros productos.

    EJEMPLOS DE RESPUESTAS PARA TEMAS NO RELACIONADOS:
    - "¬øCu√°l es el gusto del az√∫car?" ‚Üí "Lo siento, solo puedo ayudarte con consultas sobre timbres personalizados y productos de Artesellos. ¬øTe gustar√≠a saber sobre nuestros modelos de timbres disponibles?"
    - "¬øC√≥mo hacer una pizza?" ‚Üí "Disculpa, mi especialidad son los timbres personalizados. ¬øPuedo ayudarte con informaci√≥n sobre nuestros productos o hacer un pedido?"

    ${productContext}`;

    // Validar API key
    if (!process.env.OPENAI_API_KEY) {
      console.error('‚ùå OPENAI_API_KEY no configurada');
      return new Response(JSON.stringify({ error: "API key no configurada" }), { status: 500 });
    }

    console.log('üîÑ Llamando a OpenAI...');

    // Crear mensajes para OpenAI
    const openaiMessages = [
      { role: 'system', content: systemPrompt },
      ...messages.map(msg => ({
        role: msg.role,
        content: msg.content
      }))
    ];

    // Llamar a OpenAI con herramientas
    const completion = await openai.chat.completions.create({
      model: 'gpt-4o-mini',
      messages: openaiMessages,
      max_tokens: 1000,
      temperature: 0.7,
      tools: [
        {
          type: 'function',
          function: {
            name: 'consultarStock',
          description: 'Busca timbres en el inventario por marca, modelo, color o c√≥digo.',
            parameters: {
              type: 'object',
              properties: {
                termino: {
                  type: 'string',
                  description: 'El t√©rmino de b√∫squeda, ej: "Shiny 722", "Autom√°tico", "Rojo"'
                }
              },
              required: ['termino']
            }
          }
        },
        {
          type: 'function',
          function: {
            name: 'consultarInformacionNegocio',
            description: 'Proporciona informaci√≥n sobre ubicaci√≥n, horarios, contacto y datos generales del negocio.',
            parameters: {
              type: 'object',
              properties: {
                tipo: {
                  type: 'string',
                  enum: ['ubicacion', 'horarios', 'contacto', 'general'],
                  description: 'Tipo de informaci√≥n solicitada'
                }
              },
              required: ['tipo']
            }
          }
        },
        {
          type: 'function',
          function: {
            name: 'consultarInformacionEnvios',
            description: 'Proporciona informaci√≥n sobre m√©todos de env√≠o, transportes, tiempos de entrega y costos.',
            parameters: {
              type: 'object',
              properties: {
                tipo: {
                  type: 'string',
                  enum: ['metodos', 'tiempos', 'costos', 'regiones'],
                  description: 'Tipo de informaci√≥n de env√≠o solicitada'
                },
                destino: {
                  type: 'string',
                  description: 'Destino espec√≠fico para calcular tiempos (opcional)'
                }
              },
              required: ['tipo']
            }
          }
        },
        {
          type: 'function',
          function: {
            name: 'consultarInformacionPersonalizacion',
            description: 'Proporciona informaci√≥n sobre pedidos personalizados, formatos de archivo y proceso de dise√±o.',
            parameters: {
              type: 'object',
              properties: {
                aspecto: {
                  type: 'string',
                  enum: ['formatos', 'proceso', 'tiempos', 'precios', 'especificaciones'],
                  description: 'Aspecto espec√≠fico de la personalizaci√≥n'
                }
              },
              required: ['aspecto']
            }
          }
        }
      ],
      tool_choice: 'auto'
    });

    let responseText = completion.choices[0]?.message?.content || '';
    const toolCalls = completion.choices[0]?.message?.tool_calls;

    // Si hay llamadas a herramientas, ejecutarlas
    if (toolCalls && toolCalls.length > 0) {
      console.log('üîß Ejecutando herramientas...');

      for (const toolCall of toolCalls) {
        if (toolCall.function.name === 'consultarStock') {
          const { termino } = JSON.parse(toolCall.function.arguments);

          console.log(`üîç Consultando stock para: ${termino}`);

            // B√∫squeda m√°s simple y robusta
            let query = supabase.from('stock_timbres').select('*');

            // Construir condiciones de b√∫squeda
            const condiciones = [
              `marca.ilike.%${termino}%`,
              `modelo.ilike.%${termino}%`,
              `color.ilike.%${termino}%`,
              `categoria.ilike.%${termino}%`
            ];

            // Si el t√©rmino NO contiene medidas expl√≠citas (formato NxN), buscar n√∫meros de modelo
            const medidaMatch = termino.match(/(\d+)\s*[x*]\s*(\d+)/i);
            if (!medidaMatch) {
              // Solo buscar n√∫meros de modelo si NO hay medidas expl√≠citas
              const numeroMatch = termino.match(/\d+/);
              if (numeroMatch) {
                const numero = numeroMatch[0];
                condiciones.push(`modelo.ilike.%${numero}%`);
              }
            }

            query = query.or(condiciones.join(','));

            const { data, error } = await query
              .order('stock', { ascending: false })
              .limit(10);



          let toolResult = '';
            if (error) {
            console.error("‚ùå Error Supabase:", error);
            toolResult = "Error t√©cnico al consultar el inventario.";
          } else if (!data || data.length === 0) {
            // Si no encuentra resultados exactos, buscar medidas aproximadas
            const medidaMatch = termino.match(/(\d+)\s*[x*]\s*(\d+)/i);
            if (medidaMatch) {
              const anchoBuscado = parseInt(medidaMatch[1]);
              const altoBuscado = parseInt(medidaMatch[2]);

              console.log(`üîç Buscando medidas aproximadas para ${anchoBuscado}x${altoBuscado}mm`);

              // Buscar todos los productos disponibles para encontrar medidas similares
              const { data: todosProductos, error: errorAprox } = await supabase
                .from('stock_timbres')
                .select('*')
                .gt('stock', 0);

              if (!errorAprox && todosProductos && todosProductos.length > 0) {
              // Calcular similitud de medidas
              const productosConSimilitud = todosProductos.map(producto => {
                const anchoDiff = Math.abs(producto.ancho_mm - anchoBuscado);
                const altoDiff = Math.abs(producto.alto_mm - altoBuscado);
                const similitud = anchoDiff + altoDiff;

                return {
                  ...producto,
                  similitud,
                  medidas: `${producto.ancho_mm}x${producto.alto_mm}mm`
                };
              }).sort((a, b) => a.similitud - b.similitud);

              // Filtrar productos con similitud razonable (hasta 30mm de diferencia)
              const alternativas = productosConSimilitud.filter(p => p.similitud <= 30 && p.similitud > 0).slice(0, 8);

                if (alternativas.length > 0) {
                  // Agrupar alternativas por modelo
                  const alternativasPorModelo = alternativas.reduce((acc, item) => {
                    const key = `${item.marca.trim()} ${item.modelo}`;
                    if (!acc[key]) {
                      acc[key] = {
                        modelo: key,
                        medidas: `${item.ancho_mm}x${item.alto_mm}mm`,
                        diferencia: item.similitud,
                        colores: []
                      };
                    }
                    if (!acc[key].colores.includes(item.color)) {
                      acc[key].colores.push(item.color);
                    }
                    return acc;
                  }, {});

                  toolResult = `No encontr√© timbres exactamente de ${anchoBuscado}x${altoBuscado}mm, pero aqu√≠ tienes alternativas con medidas similares:\n\n`;

                  Object.values(alternativasPorModelo).forEach((alt: any) => {
                    toolResult += `‚Ä¢ **${alt.modelo}** - Medidas: ${alt.medidas}`;
                    if (alt.diferencia > 0) {
                      toolResult += ` (diferencia: ${alt.diferencia}mm)`;
                    }
                    toolResult += `\n  Colores: ${alt.colores.join(', ')}\n\n`;
                  });

                  toolResult += `¬øTe interesar√≠a alguno de estos modelos alternativos?`;
                }
              }
            }

            // Solo establecer mensaje gen√©rico si no se ha establecido toolResult antes
            if (!toolResult || toolResult === '') {
              toolResult = "No encontr√© productos que coincidan con la b√∫squeda. ¬øPuedes ser m√°s espec√≠fico?";
            }
          } else {
            // Separar productos disponibles y todos los productos encontrados
            const productosDisponibles = data.filter(item => item.stock > 0);
            const todosLosProductos = data; // Incluir productos con stock 0 para mostrar todos los colores

            if (productosDisponibles.length === 0) {
              toolResult = "No hay stock disponible para los productos encontrados.";
            } else {
              // Agrupar TODOS los productos por modelo (incluyendo sin stock) para mostrar colores completos
              const productosPorModelo = todosLosProductos.reduce((acc, item) => {
                const key = `${item.marca.trim()} ${item.modelo}`;
                if (!acc[key]) {
                  acc[key] = {
                    modelo: key,
              medidas: `${item.ancho_mm}x${item.alto_mm}mm`,
                    coloresDisponibles: [], // Colores con stock > 0
                    coloresSinStock: [],    // Colores con stock = 0
                    precio: item.precio || null,
                    imagen_url: null
                  };
                }

                // Clasificar colores seg√∫n disponibilidad
                if (item.stock > 0) {
                  if (!acc[key].coloresDisponibles.includes(item.color)) {
                    acc[key].coloresDisponibles.push(item.color);
                  }
                  // Guardar la primera imagen disponible para este modelo
                  if (!acc[key].imagen_url && item.imagen_url) {
                    acc[key].imagen_url = item.imagen_url;
                  }
                } else {
                  if (!acc[key].coloresSinStock.includes(item.color)) {
                    acc[key].coloresSinStock.push(item.color);
                  }
                }

                // Usar el precio del primer producto encontrado (deber√≠an ser iguales por modelo)
                if (!acc[key].precio && item.precio) {
                  acc[key].precio = item.precio;
                }
                return acc;
              }, {});


              const resumenProductos = Object.values(productosPorModelo).map((producto: any) => {
                let respuesta = `**${producto.modelo}**\n`;
                respuesta += `üìè Medidas: ${producto.medidas}\n`;
                respuesta += `üé® Colores disponibles: ${producto.coloresDisponibles.join(', ')}\n`;
                if (producto.coloresSinStock.length > 0) {
                  respuesta += `‚ùå Colores sin stock: ${producto.coloresSinStock.join(', ')}\n`;
                }
                if (producto.precio) {
                  respuesta += `üí∞ Precio: $${producto.precio.toLocaleString('es-CL')}\n`;
                }
                if (producto.imagen_url) {
                  respuesta += `\n![${producto.modelo}](${producto.imagen_url})\n`;
                }
                respuesta += `\n---\n`;
                return respuesta;
              }).slice(0, 5);

              // Crear respuesta espec√≠fica seg√∫n la consulta del usuario
              const consultaUsuario = messages[messages.length - 1]?.content?.toLowerCase() || '';

              // L√≥gica general para cualquier producto
              const coloresDisponibles = ['rojo', 'dorado', 'azul', 'verde', 'rosa', 'negro', 'violeta', 'lila'];
              const consultaLower = consultaUsuario.toLowerCase();

              // Detectar modelo mencionado en la consulta
              const modelosDisponibles = Object.keys(productosPorModelo);
              let modeloMencionado = extraerModeloDeConsulta(consultaUsuario, modelosDisponibles);

              // Actualizar contexto si se mencion√≥ un modelo
              if (modeloMencionado) {
                productoEnContexto = modeloMencionado;
              }

              // Si no se mencion√≥ un modelo espec√≠fico, buscar en el historial de mensajes
              if (!modeloMencionado &&
                  (consultaLower.includes('color') || consultaLower.includes('colores') ||
                   consultaLower.includes('otro') || consultaLower.includes('otros') ||
                   consultaLower.includes('m√°s') || consultaLower.includes('tienes') ||
                   coloresDisponibles.some(color => consultaLower.includes(color)))) {

                // Revisar mensajes anteriores para encontrar menciones de modelos
                for (let i = messages.length - 2; i >= 0; i--) {
                  const mensajeAnterior = messages[i];
                  if (mensajeAnterior.role === 'user') {
                    const modeloEnMensajeAnterior = extraerModeloDeConsulta(mensajeAnterior.content, modelosDisponibles);
                    if (modeloEnMensajeAnterior) {
                      modeloMencionado = modeloEnMensajeAnterior;
                      break;
                    }
                  }
                }

                // Si a√∫n no encontramos, usar el contexto global
                if (!modeloMencionado && productoEnContexto) {
                  modeloMencionado = productoEnContexto;
                }
              }

              // Buscar colores para el modelo detectado
              let colorEspecificoPreguntado = null;
              if (modeloMencionado) {
                colorEspecificoPreguntado = coloresDisponibles.find(color =>
                  consultaLower.includes(color)
                );
              }


              if (colorEspecificoPreguntado && modeloMencionado) {
                // Buscar el producto espec√≠fico del color preguntado
                const productosDisponibles = data.filter(item =>
                  item.stock > 0 &&
                  item.modelo === modeloMencionado.split(' ')[1] && // Extraer n√∫mero del modelo
                  item.color.toLowerCase().includes(colorEspecificoPreguntado)
                );

                if (productosDisponibles.length > 0) {
                  const producto = productosDisponibles[0];
                  toolResult = `Aqu√≠ tienes el timbre **${modeloMencionado}** en color ${producto.color}:\n\n`;
                  toolResult += `üìè Medidas: ${producto.ancho_mm}x${producto.alto_mm}mm\n`;
                  if (producto.precio) {
                    toolResult += `üí∞ Precio: $${producto.precio.toLocaleString('es-CL')}\n`;
                  } else {
                    toolResult += `üí∞ Precio: Consulta por precio espec√≠fico\n`;
                  }
                  if (producto.imagen_url) {
                    toolResult += `\n![${modeloMencionado} ${producto.color}](${producto.imagen_url})\n`;
                  }
                  toolResult += `\nSi deseas hacer un pedido o necesitas m√°s informaci√≥n, ¬°estar√© encantado de ayudarte!`;
                } else {
                  toolResult = `Lo siento, no tenemos disponible el timbre ${modeloMencionado} en el color que mencionas. Los colores disponibles son: ${productosPorModelo[modeloMencionado]?.colores.join(', ') || 'consulta general'}.`;
                }
              } else if (consultaUsuario.includes('color') || consultaUsuario.includes('colores')) {
                // Si se pregunta por colores y hay un modelo en contexto
                if (modeloMencionado && productosPorModelo[modeloMencionado]) {
                  const coloresModelo = productosPorModelo[modeloMencionado].colores || [];
                  if (coloresModelo.length > 0) {
                    toolResult = `El timbre ${modeloMencionado} est√° disponible en los siguientes colores: ${coloresModelo.join(', ')}. Todos estos colores tienen stock disponible actualmente.`;
                  } else {
                    toolResult = `No hay informaci√≥n espec√≠fica de colores para el ${modeloMencionado} en este momento.`;
                  }
                } else {
                  // Respuesta general sobre productos disponibles
                  toolResult = `Tenemos varios modelos disponibles. ${resumenProductos.join('\n')}`;
                }
              } else if ((consultaUsuario.includes('mostrar') || consultaUsuario.includes('ver') || consultaUsuario.includes('imagen') || consultaUsuario.includes('foto')) && modeloMencionado) {
                // Si pide mostrar/ver im√°genes de un modelo espec√≠fico
                const productosConImagen = data.filter(item =>
                  item.stock > 0 &&
                  item.modelo === modeloMencionado.split(' ')[1] &&
                  item.imagen_url
                );

                if (productosConImagen.length > 0) {
                  const producto = productosPorModelo[modeloMencionado];

                  // Seleccionar imagen representativa
                  productosConImagen.sort((a, b) => {
                    const prioridades = { 'negro': 3, 'azul': 2 };
                    const prioridadA = prioridades[a.color.toLowerCase()] || 1;
                    const prioridadB = prioridades[b.color.toLowerCase()] || 1;

                    if (prioridadA !== prioridadB) return prioridadB - prioridadA;
                    return b.stock - a.stock;
                  });

                  const imagenSeleccionada = productosConImagen[0];
                  toolResult = `Aqu√≠ tienes una imagen del timbre **${producto.modelo}**:\n\n`;
                  toolResult += `üé® Colores disponibles: ${producto.coloresDisponibles.join(', ')}\n`;
                  if (producto.coloresSinStock.length > 0) {
                    toolResult += `‚ùå Colores sin stock: ${producto.coloresSinStock.join(', ')}\n`;
                  }
                  toolResult += `üìè Medidas: ${producto.medidas}\n`;
                  if (producto.precio) {
                    toolResult += `üí∞ Precio: $${producto.precio.toLocaleString('es-CL')}\n`;
                  }
                  toolResult += `\n![${producto.modelo} - ${imagenSeleccionada.color}](${imagenSeleccionada.imagen_url})\n\n`;
                  toolResult += `Si deseas ver un color espec√≠fico o necesitas m√°s informaci√≥n, ¬°h√°zmelo saber!`;
                } else {
                  toolResult = `Lo siento, no tengo im√°genes disponibles del ${modeloMencionado} en este momento, pero puedo confirmarte que est√° disponible en varios colores.`;
                }
              } else if (modeloMencionado && productosPorModelo[modeloMencionado]) {
                // Si pregunta espec√≠ficamente por un modelo, mostrar detalles con imagen
                const producto = productosPorModelo[modeloMencionado];

                // Encontrar una imagen disponible para mostrar
                const productosConImagen = data.filter(item =>
                  item.stock > 0 &&
                  item.modelo === modeloMencionado.split(' ')[1] &&
                  item.imagen_url
                );

                toolResult = `¬°S√≠! El timbre **${producto.modelo}** est√° disponible.\n\n`;
                toolResult += `üìè Medidas: ${producto.medidas}\n`;
                toolResult += `üé® Colores disponibles: ${producto.coloresDisponibles.join(', ')}\n`;
                if (producto.coloresSinStock.length > 0) {
                  toolResult += `‚ùå Colores sin stock: ${producto.coloresSinStock.join(', ')}\n`;
                }
                if (producto.precio) {
                  toolResult += `üí∞ Precio: $${producto.precio.toLocaleString('es-CL')}\n`;
                }

                // Mostrar im√°genes de todos los colores disponibles que tengan imagen
                if (productosConImagen.length > 0) {
                  // Mostrar hasta 3 im√°genes de diferentes colores
                  const imagenesAMostrar = productosConImagen.slice(0, 3);
                  toolResult += `\n**Im√°genes disponibles:**\n`;
                  imagenesAMostrar.forEach(imagen => {
                    toolResult += `![${producto.modelo} - ${imagen.color}](${imagen.imagen_url})\n`;
                  });
                }

                toolResult += `\nSi deseas ver un color espec√≠fico o necesitas m√°s informaci√≥n, ¬°h√°zmelo saber!`;
              } else {
                // Respuesta general para otras consultas
                toolResult = `Productos disponibles:\n\n${resumenProductos.join('\n')}`;
              }
          else if (toolCall.function.name === 'consultarInformacionNegocio') {
          const { tipo } = JSON.parse(toolCall.function.arguments);

          console.log(`üè¢ Consultando informaci√≥n de negocio: ${tipo}`);

          switch (tipo) {
            case 'ubicacion':
              toolResult = `üìç **Ubicaci√≥n de Artesellos:**
- Direcci√≥n: Centro de Santiago (Providencia), Chile
- Estamos ubicados en una zona c√©ntrica, f√°cil acceso en transporte p√∫blico
- Parking disponible en las inmediaciones

¬øTe gustar√≠a saber nuestros horarios de atenci√≥n o c√≥mo llegar?`;
              break;
            case 'horarios':
              toolResult = `üïí **Horarios de Atenci√≥n:**
- Lunes a Viernes: 9:00 - 18:00 hrs
- S√°bados: 10:00 - 14:00 hrs
- Domingos: Cerrado
- Feriados: Cerrado (excepto feriados irrenunciables)

Para pedidos urgentes, puedes contactarnos por WhatsApp y evaluamos atenci√≥n especial.`;
              break;
            case 'contacto':
              toolResult = `üìû **Informaci√≥n de Contacto:**
- Tel√©fono: +56 9 XXXX XXXX
- WhatsApp: Disponible para consultas r√°pidas
- Email: contacto@artesellos.cl
- Sitio web: www.artesellos.cl

¬°Preferimos WhatsApp para consultas r√°pidas y presupuesto inmediato!`;
              break;
            case 'general':
            default:
              toolResult = `üè™ **Informaci√≥n General de Artesellos:**
Somos especialistas en timbres personalizados profesionales desde 2010.

**Servicios principales:**
- Timbres est√°ndar y personalizados
- Dise√±o gr√°fico profesional
- Reparaci√≥n y mantenimiento de timbres
- Asesor√≠a para elegir el timbre adecuado

**Nuestra especialidad:** Timbres para profesionales liberales, empresas y comercios.

¬øTe gustar√≠a saber sobre alg√∫n servicio espec√≠fico?`;
              break;
          }
        } else if (toolCall.function.name === 'consultarInformacionEnvios') {
          const { tipo, destino } = JSON.parse(toolCall.function.arguments);

          console.log(`üöö Consultando informaci√≥n de env√≠os: ${tipo}`, destino ? `(destino: ${destino})` : '');

          switch (tipo) {
            case 'metodos':
              toolResult = `üöö **M√©todos de Env√≠o Disponibles:**

**Transportes principales:**
‚Ä¢ **Chilexpress**: Servicio est√°ndar y express
‚Ä¢ **Starken**: Entrega puerta a puerta
‚Ä¢ **CorreosChile**: Servicio econ√≥mico nacional

**Opciones adicionales:**
‚Ä¢ **Retiro en tienda**: ¬°Gratis! Mismo d√≠a disponible
‚Ä¢ **Env√≠o express**: Servicio premium con costo adicional

Todos nuestros env√≠os incluyen seguro y seguimiento en tiempo real.`;
              break;
            case 'tiempos':
              if (destino) {
                // L√≥gica simplificada para tiempos seg√∫n destino
                const destinoLower = destino.toLowerCase();
                if (destinoLower.includes('santiago') || destinoLower.includes('providencia')) {
                  toolResult = `‚è±Ô∏è **Tiempos de entrega para ${destino}:**
- Chilexpress: 1-2 d√≠as h√°biles
- Starken: 1-2 d√≠as h√°biles
- Retiro en tienda: ¬°Mismo d√≠a!

Los pedidos realizados antes de las 14:00 hrs salen el mismo d√≠a.`;
                } else if (destinoLower.includes('valparaiso') || destinoLower.includes('vina') || destinoLower.includes('rancagua')) {
                  toolResult = `‚è±Ô∏è **Tiempos de entrega para ${destino}:**
- Chilexpress: 2-3 d√≠as h√°biles
- Starken: 2-4 d√≠as h√°biles

Tiempos pueden variar seg√∫n condiciones clim√°ticas.`;
                } else {
                  toolResult = `‚è±Ô∏è **Tiempos de entrega para ${destino}:**
- Regiones centrales: 3-5 d√≠as h√°biles
- Regiones extremas: 4-7 d√≠as h√°biles

Para destinos espec√≠ficos, confirma tiempos exactos al realizar el pedido.`;
                }
              } else {
                toolResult = `‚è±Ô∏è **Tiempos Aproximados de Entrega:**

**Santiago y alrededores:** 1-2 d√≠as h√°biles
**Regiones centrales:** 2-4 d√≠as h√°biles
**Regiones extremas:** 4-7 d√≠as h√°biles
**Retiro en tienda:** ¬°Mismo d√≠a!

*Los tiempos son h√°biles y pueden variar por condiciones clim√°ticas o alta demanda.*`;
              }
              break;
            case 'costos':
              toolResult = `üí∞ **Costos de Env√≠o:**

**Tarifas aproximadas:**
- Env√≠os a Santiago: $3.500 - $5.500
- Env√≠os a regiones: $4.500 - $8.500
- Env√≠os express: +$2.000 adicionales

**Costos seg√∫n peso y distancia:**
- Timbres peque√±os: $3.500 - $4.500
- Timbres grandes: $5.500 - $7.500
- M√∫ltiples unidades: Cotizaci√≥n especial

**¬°Retiro en tienda: GRATIS!**

Los costos se calculan autom√°ticamente al finalizar la compra.`;
              break;
            case 'regiones':
              toolResult = `üåç **Env√≠os a Todo Chile:**

‚úÖ **Regiones cubiertas:**
- Todo Chile continental
- Isla de Pascua y Juan Fern√°ndez (consultar)
- Entregas puerta a puerta en zonas urbanas

‚ùó **Restricciones:**
- Algunos sectores rurales pueden tener costos adicionales
- Condiciones clim√°ticas pueden afectar tiempos

¬øNecesitas env√≠o a alguna regi√≥n espec√≠fica? ¬°Podemos cotizarlo!`;
              break;
            default:
              toolResult = `üöö **Informaci√≥n General de Env√≠os:**

Realizamos env√≠os a todo Chile con diferentes transportistas.
- M√∫ltiples opciones de transporte
- Seguro incluido en todos los env√≠os
- Seguimiento en tiempo real
- Retiro gratuito en tienda

¬øTe gustar√≠a saber sobre costos, tiempos o m√©todos espec√≠ficos?`;
              break;
          }
        } else if (toolCall.function.name === 'consultarInformacionPersonalizacion') {
          const { aspecto } = JSON.parse(toolCall.function.arguments);

          console.log(`üé® Consultando informaci√≥n de personalizaci√≥n: ${aspecto}`);

          switch (aspecto) {
            case 'formatos':
              toolResult = `üìÑ **Formatos de Archivo Aceptados:**

**Formatos Recomendados (Vectores):**
‚Ä¢ **Adobe Illustrator** (.AI) - Ideal
‚Ä¢ **Corel Draw** (.CDR) - Perfecto
‚Ä¢ **EPS** - Muy bueno
‚Ä¢ **PDF Vectorial** - Aceptable

**Formatos de Imagen (si no tienes vector):**
‚Ä¢ **PNG** o **JPG** de alta resoluci√≥n (m√≠nimo 300 DPI)
‚Ä¢ Tama√±o recomendado: M√≠nimo 1000x1000 p√≠xeles

**Formatos de Texto:**
‚Ä¢ **Documento Word** (.DOC, .DOCX)
‚Ä¢ **Archivo de texto** (.TXT)
‚Ä¢ **PDF** con texto editable

**¬°Importante:** Los archivos vectoriales garantizan mejor calidad final.`;
              break;
            case 'proceso':
              toolResult = `‚öôÔ∏è **Proceso de Pedido Personalizado:**

**Paso 1: Consulta Inicial**
- Conversa con nosotros sobre tu idea
- Te asesoramos sobre opciones disponibles

**Paso 2: Env√≠o de Dise√±o**
- Env√≠anos tu logo, texto o idea
- Podemos ayudarte a crear el dise√±o si no lo tienes

**Paso 3: Revisi√≥n y Aprobaci√≥n**
- Te mostramos una previsualizaci√≥n
- Ajustes gratuitos hasta tu aprobaci√≥n

**Paso 4: Fabricaci√≥n**
- 7-15 d√≠as h√°biles seg√∫n complejidad
- Te mantenemos informado del progreso

**Paso 5: Entrega**
- Env√≠o seguro a tu direcci√≥n
- Seguimiento en tiempo real

**¬øListo para empezar tu timbre personalizado?**`;
              break;
            case 'tiempos':
              toolResult = `‚è∞ **Tiempos de Fabricaci√≥n:**

**Timbres est√°ndar:** 3-5 d√≠as h√°biles
**Personalizaciones simples:** 7-10 d√≠as h√°biles
**Dise√±os complejos:** 10-15 d√≠as h√°biles
**Timbres grandes o especiales:** 15-20 d√≠as h√°biles

*Estos tiempos son adicionales al tiempo de env√≠o.*
*Para pedidos urgentes, consulta disponibilidad de prioridad.*`;
              break;
            case 'precios':
              toolResult = `üí∞ **Precios de Timbres Personalizados:**

**Rango de precios:**
- **Timbres b√°sicos:** $25.000 - $35.000
- **Con logo simple:** $35.000 - $50.000
- **Dise√±os complejos:** $50.000 - $80.000
- **Timbres grandes:** $60.000 - $100.000

**Factores que afectan el precio:**
‚Ä¢ Complejidad del dise√±o
‚Ä¢ N√∫mero de colores
‚Ä¢ Tama√±o del timbre
‚Ä¢ Cantidad de texto/l√≠neas
‚Ä¢ Materiales especiales

**¬°Presupuestos gratuitos y sin compromiso!**

¬øQuieres que te prepare un presupuesto para tu idea?`;
              break;
            case 'especificaciones':
              toolResult = `üìè **Especificaciones T√©cnicas:**

**Medidas disponibles:**
‚Ä¢ M√≠nimo: 14x14 mm
‚Ä¢ M√°ximo: 82x82 mm
‚Ä¢ Medidas personalizadas: Consultar

**Capacidades de texto:**
‚Ä¢ Hasta 12 l√≠neas de texto
‚Ä¢ M√∫ltiples fuentes disponibles
‚Ä¢ Alineaci√≥n: Izquierda, centro, derecha

**Opciones de tinta:**
‚Ä¢ Negro est√°ndar
‚Ä¢ Colores especiales (consultar)
‚Ä¢ Tinta indeleble de secado r√°pido

**Materiales:**
‚Ä¢ Policarbonato de alta calidad
‚Ä¢ Resistente al desgaste
‚Ä¢ Vida √∫til: 100.000+ impresiones

**Opciones especiales:**
‚Ä¢ C√≥digos QR integrados
‚Ä¢ N√∫meros autom√°ticos
‚Ä¢ Fechas variables
‚Ä¢ Logos e im√°genes

¬øTienes alguna especificaci√≥n particular en mente?`;
              break;
            default:
              toolResult = `üé® **Informaci√≥n sobre Pedidos Personalizados:**

Creamos timbres completamente a tu medida con tu dise√±o personalizado.

**¬øQu√© podemos hacer?**
- Dise√±os √∫nicos con tu logo
- Texto personalizado
- Combinaci√≥n de im√°genes y texto
- Adaptaci√≥n a tus necesidades espec√≠ficas

**Proceso simple:**
1. Cu√©ntanos tu idea
2. Env√≠a tu dise√±o (o te ayudamos a crearlo)
3. Aprueba el dise√±o
4. Recibe tu timbre personalizado

¬øQuieres contarme sobre el timbre que necesitas?`;
              break;
          }
        }

        // Agregar resultado de la herramienta al contexto
          openaiMessages.push({
            role: 'assistant',
            content: responseText,
            tool_calls: [toolCall]
          } as any);

          openaiMessages.push({
            role: 'tool',
            tool_call_id: toolCall.id,
            content: toolResult
          } as any);

          // Generar respuesta final con el contexto de la herramienta
          const finalCompletion = await openai.chat.completions.create({
            model: 'gpt-4o-mini',
            messages: openaiMessages,
            max_tokens: 1000,
            temperature: 0.7,
          });

          responseText = finalCompletion.choices[0]?.message?.content || 'Lo siento, no pude generar una respuesta.';
        }
      }
    }

    console.log('‚úÖ Respuesta generada correctamente');

    // Crear respuesta en formato streaming simple
    const streamResponse = new ReadableStream({
      start(controller) {
        const data = JSON.stringify({ content: responseText });
        controller.enqueue(`data: ${data}\n\n`);
        controller.enqueue('data: [DONE]\n\n');
        controller.close();
      }
    });

    return new Response(streamResponse, {
      headers: {
        'Content-Type': 'text/plain; charset=utf-8',
        'Cache-Control': 'no-cache',
        'Connection': 'keep-alive',
      },
    });

  } catch (error) {
    console.error("‚ùå Error:", error);
    return new Response(JSON.stringify({
      error: "Error interno",
      details: error.message
    }), { status: 500 });
  }
}